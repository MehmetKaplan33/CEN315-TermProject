name: Java CI with Maven (Full Suite)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      # 1. KODU √áEK
      - uses: actions/checkout@v4

      # 2. JAVA 21 KUR
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # 3. DERLEME VE TESTLER
      - name: Build and Test with Maven
        run: mvn -B verify --file pom.xml

      # --- JACOCO SUMMARY (PR Comment) ---
      - name: JaCoCo Report Summary (PR Comment)
        uses: Madrapps/jacoco-report@v1.6.1
        with:
          paths: ${{ github.workspace }}/target/site/jacoco/jacoco.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 80
          title: "üìä JaCoCo Code Coverage Summary"
          update-comment: true

      # JaCoCo Summary (Debug eklenmi≈ü)
      - name: Add JaCoCo to Step Summary
        run: |
          echo "### üìä JaCoCo Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          JACOCO_HTML="target/site/jacoco/index.html"
          
          if [ -f "$JACOCO_HTML" ]; then
            # Bar satƒ±rlarƒ±nƒ± dosyaya yaz
            grep '<tfoot>' -A 5 "$JACOCO_HTML" | grep 'class="bar"' > /tmp/bars.txt
          
            echo "DEBUG: Bar satƒ±rlarƒ±:" >> /tmp/debug.log
            cat /tmp/bars.txt >> /tmp/debug.log
          
            # ƒ∞lk satƒ±r: Instruction
            INST_LINE=$(sed -n '1p' /tmp/bars.txt)
            INST_MISSED=$(echo "$INST_LINE" | sed -n 's/.*>\([0-9]*\) of \([0-9]*\)<.*/\1/p')
            INST_TOTAL=$(echo "$INST_LINE" | sed -n 's/.*>\([0-9]*\) of \([0-9]*\)<.*/\2/p')
          
            echo "DEBUG: INST_MISSED=$INST_MISSED, INST_TOTAL=$INST_TOTAL" >> /tmp/debug.log
          
            if [ -n "$INST_TOTAL" ] && [ "$INST_TOTAL" -gt 0 ]; then
              INST_COVERED=$((INST_TOTAL - INST_MISSED))
              INST_PCT=$(awk "BEGIN {printf \"%.0f\", ($INST_COVERED/$INST_TOTAL)*100}")
            else
              INST_PCT="N/A"
            fi
          
            # ƒ∞kinci satƒ±r: Branch
            BRANCH_LINE=$(sed -n '2p' /tmp/bars.txt)
            BRANCH_MISSED=$(echo "$BRANCH_LINE" | sed -n 's/.*>\([0-9]*\) of \([0-9]*\)<.*/\1/p')
            BRANCH_TOTAL=$(echo "$BRANCH_LINE" | sed -n 's/.*>\([0-9]*\) of \([0-9]*\)<.*/\2/p')
          
            echo "DEBUG: BRANCH_LINE=$BRANCH_LINE" >> /tmp/debug.log
            echo "DEBUG: BRANCH_MISSED=$BRANCH_MISSED, BRANCH_TOTAL=$BRANCH_TOTAL" >> /tmp/debug.log
          
            if [ -n "$BRANCH_TOTAL" ] && [ "$BRANCH_TOTAL" -gt 0 ]; then
              BRANCH_COVERED=$((BRANCH_TOTAL - BRANCH_MISSED))
              BRANCH_PCT=$(awk "BEGIN {printf \"%.0f\", ($BRANCH_COVERED/$BRANCH_TOTAL)*100}")
            else
              BRANCH_PCT="N/A"
            fi
          
            # Tablo
            echo "| Metric | Coverage | Status |" >> $GITHUB_STEP_SUMMARY
            echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
            echo "| **Instruction Coverage** | ${INST_PCT}% | $([ "$INST_PCT" != "N/A" ] && [ $INST_PCT -ge 80 ] && echo "‚úÖ" || echo "‚ö†Ô∏è") |" >> $GITHUB_STEP_SUMMARY
            echo "| **Branch Coverage** | ${BRANCH_PCT}% | $([ "$BRANCH_PCT" != "N/A" ] && [ $BRANCH_PCT -ge 80 ] && echo "‚úÖ" || echo "‚ö†Ô∏è") |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          
            # Debug √ßƒ±ktƒ±sƒ±nƒ± g√∂ster
            echo "<details><summary>üîç Debug Log</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/debug.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è JaCoCo HTML raporu bulunamadƒ±!" >> $GITHUB_STEP_SUMMARY
          fi

      # 4. JACOCO RAPORUNU Y√úKLE
      - name: Upload JaCoCo Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/

      # 5. PITEST (Debug eklenmi≈ü)
      - name: Run PITest and Extract Summary
        run: |
          mvn org.pitest:pitest-maven:mutationCoverage
          
          PITEST_HTML="target/pit-reports/index.html"
          
          echo "### üß¨ Mutation Testing Summary (PITest)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "$PITEST_HTML" ]; then
            echo "DEBUG: PITest HTML bulundu" >> /tmp/pitest_debug.log
          
            # Project Summary tablosunu bul
            grep -A 10 '<h3>Project Summary</h3>' "$PITEST_HTML" > /tmp/pitest_table.txt
            cat /tmp/pitest_table.txt >> /tmp/pitest_debug.log
          
            # Line Coverage: width-XX class'ƒ±ndan √ßek
            LINE_COV=$(grep -oP 'width-\K\d+' /tmp/pitest_table.txt | sed -n '1p' || echo "0")
            LINE_RATIO=$(grep -oP '\d+/\d+' /tmp/pitest_table.txt | sed -n '1p' || echo "0/0")
          
            # Mutation Coverage
            MUT_COV=$(grep -oP 'width-\K\d+' /tmp/pitest_table.txt | sed -n '2p' || echo "0")
            MUT_RATIO=$(grep -oP '\d+/\d+' /tmp/pitest_table.txt | sed -n '2p' || echo "0/0")
          
            # Test Strength
            TEST_STR=$(grep -oP 'width-\K\d+' /tmp/pitest_table.txt | sed -n '3p' || echo "0")
            TEST_RATIO=$(grep -oP '\d+/\d+' /tmp/pitest_table.txt | sed -n '3p' || echo "0/0")
          
            echo "DEBUG: LINE_COV=$LINE_COV ($LINE_RATIO)" >> /tmp/pitest_debug.log
            echo "DEBUG: MUT_COV=$MUT_COV ($MUT_RATIO)" >> /tmp/pitest_debug.log
            echo "DEBUG: TEST_STR=$TEST_STR ($TEST_RATIO)" >> /tmp/pitest_debug.log
          
            # Tablo
            echo "| Metric | Score | Status |" >> $GITHUB_STEP_SUMMARY
            echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
            echo "| **Line Coverage** | ${LINE_COV}% (${LINE_RATIO}) | $([ $LINE_COV -ge 80 ] && echo "‚úÖ" || echo "‚ö†Ô∏è") |" >> $GITHUB_STEP_SUMMARY
            echo "| **Mutation Coverage** | ${MUT_COV}% (${MUT_RATIO}) | $([ $MUT_COV -ge 80 ] && echo "‚úÖ" || echo "‚ö†Ô∏è") |" >> $GITHUB_STEP_SUMMARY
            echo "| **Test Strength** | ${TEST_STR}% (${TEST_RATIO}) | $([ $TEST_STR -ge 80 ] && echo "‚úÖ" || echo "‚ö†Ô∏è") |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          
            # Debug
            echo "<details><summary>üîç PITest Debug</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/pitest_debug.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è PITest raporu bulunamadƒ±!" >> $GITHUB_STEP_SUMMARY
          fi

      # 6. PITEST RAPORUNU Y√úKLE
      - name: Upload PITest Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pitest-report
          path: target/pit-reports/
