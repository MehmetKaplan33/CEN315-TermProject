name: Java CI with Maven (Full Suite)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      # 1. KODU Ã‡EK
      - uses: actions/checkout@v4

      # 2. JAVA 21 KUR
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # 3. DERLEME VE TESTLER
      - name: Build and Test with Maven
        run: mvn -B verify --file pom.xml

      # --- JACOCO SUMMARY (PR Comment + Summary) ---
      - name: JaCoCo Report Summary (PR Comment)
        uses: Madrapps/jacoco-report@v1.6.1
        with:
          paths: ${{ github.workspace }}/target/site/jacoco/jacoco.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 80
          title: "ðŸ“Š JaCoCo Code Coverage Summary"
          update-comment: true

      # JaCoCo Summary'e de ekle
      - name: Add JaCoCo to Step Summary
        run: |
          echo "### ðŸ“Š JaCoCo Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # jacoco.xml'den coverage verilerini Ã§ek
          JACOCO_XML="target/site/jacoco/jacoco.xml"
          
          if [ -f "$JACOCO_XML" ]; then
            # Instruction coverage (genel)
            INSTRUCTION_COVERED=$(grep -o 'type="INSTRUCTION".*covered="[0-9]*"' "$JACOCO_XML" | grep -oP 'covered="\K[0-9]+' | head -1)
            INSTRUCTION_MISSED=$(grep -o 'type="INSTRUCTION".*missed="[0-9]*"' "$JACOCO_XML" | grep -oP 'missed="\K[0-9]+' | head -1)
          
            # Branch coverage
            BRANCH_COVERED=$(grep -o 'type="BRANCH".*covered="[0-9]*"' "$JACOCO_XML" | grep -oP 'covered="\K[0-9]+' | head -1)
            BRANCH_MISSED=$(grep -o 'type="BRANCH".*missed="[0-9]*"' "$JACOCO_XML" | grep -oP 'missed="\K[0-9]+' | head -1)
          
            # Line coverage
            LINE_COVERED=$(grep -o 'type="LINE".*covered="[0-9]*"' "$JACOCO_XML" | grep -oP 'covered="\K[0-9]+' | head -1)
            LINE_MISSED=$(grep -o 'type="LINE".*missed="[0-9]*"' "$JACOCO_XML" | grep -oP 'missed="\K[0-9]+' | head -1)
          
            # YÃ¼zdeleri hesapla
            if [ -n "$INSTRUCTION_COVERED" ] && [ -n "$INSTRUCTION_MISSED" ]; then
              TOTAL_INST=$((INSTRUCTION_COVERED + INSTRUCTION_MISSED))
              INST_PCT=$(awk "BEGIN {printf \"%.1f\", ($INSTRUCTION_COVERED/$TOTAL_INST)*100}")
            else
              INST_PCT="0.0"
            fi
          
            if [ -n "$BRANCH_COVERED" ] && [ -n "$BRANCH_MISSED" ]; then
              TOTAL_BRANCH=$((BRANCH_COVERED + BRANCH_MISSED))
              BRANCH_PCT=$(awk "BEGIN {printf \"%.1f\", ($BRANCH_COVERED/$TOTAL_BRANCH)*100}")
            else
              BRANCH_PCT="0.0"
            fi
          
            if [ -n "$LINE_COVERED" ] && [ -n "$LINE_MISSED" ]; then
              TOTAL_LINE=$((LINE_COVERED + LINE_MISSED))
              LINE_PCT=$(awk "BEGIN {printf \"%.1f\", ($LINE_COVERED/$TOTAL_LINE)*100}")
            else
              LINE_PCT="0.0"
            fi
          
            # Tablo oluÅŸtur
            echo "| Metric | Coverage | Status |" >> $GITHUB_STEP_SUMMARY
            echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
            echo "| **Instruction Coverage** | ${INST_PCT}% | $(awk "BEGIN {exit ($INST_PCT >= 80) ? 0 : 1}" && echo "âœ…" || echo "âš ï¸") |" >> $GITHUB_STEP_SUMMARY
            echo "| **Branch Coverage** | ${BRANCH_PCT}% | $(awk "BEGIN {exit ($BRANCH_PCT >= 80) ? 0 : 1}" && echo "âœ…" || echo "âš ï¸") |" >> $GITHUB_STEP_SUMMARY
            echo "| **Line Coverage** | ${LINE_PCT}% | $(awk "BEGIN {exit ($LINE_PCT >= 80) ? 0 : 1}" && echo "âœ…" || echo "âš ï¸") |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ JaCoCo raporu bulunamadÄ±!" >> $GITHUB_STEP_SUMMARY
          fi

      # 4. JACOCO RAPORUNU YÃœKLE
      - name: Upload JaCoCo Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/

      # 5. PITEST (MUTASYON) VE DÄ°NAMÄ°K VERÄ° Ã‡EKME (DÃœZELTÄ°LDÄ°)
      - name: Run PITest and Extract Summary
        run: |
          mvn org.pitest:pitest-maven:mutationCoverage
          
          # PITest mutations.xml dosyasÄ±ndan doÄŸru verileri Ã§ek
          MUTATIONS_XML="target/pit-reports/mutations.xml"
          
          if [ -f "$MUTATIONS_XML" ]; then
            # XML'den mutation coverage hesapla
            KILLED=$(grep -o '<status>KILLED</status>' "$MUTATIONS_XML" | wc -l)
            TOTAL=$(grep -o '<mutation ' "$MUTATIONS_XML" | wc -l)
          
            if [ "$TOTAL" -gt 0 ]; then
              MUT_COV=$(awk "BEGIN {printf \"%.0f\", ($KILLED/$TOTAL)*100}")
            else
              MUT_COV="0"
            fi
          
            # Line coverage iÃ§in index.html'den Ã§ek
            LINE_COV=$(grep -oP 'Total.*?<td>(\d+)%' target/pit-reports/index.html | grep -oP '\d+' | head -1 || echo "0")
          else
            MUT_COV="0"
            LINE_COV="0"
          fi
          
          echo "### ðŸ§¬ Mutation Testing Summary (PITest)" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Score | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Mutation Coverage** | ${MUT_COV}% | $([ $MUT_COV -ge 80 ] && echo "âœ…" || echo "âš ï¸") |" >> $GITHUB_STEP_SUMMARY
          echo "| **Line Coverage** | ${LINE_COV}% | âœ… |" >> $GITHUB_STEP_SUMMARY

      # 6. PITEST RAPORUNU YÃœKLE
      - name: Upload PITest Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pitest-report
          path: target/pit-reports/

      # 7. UYGULAMAYI ARKA PLANDA BAÅžLAT
      - name: Start Spring Boot App
        run: |
          nohup java -jar target/*.jar > app.log 2>&1 &
          echo "Uygulama baÅŸlatÄ±lÄ±yor, 25 saniye bekleniyor..."
          sleep 25
          curl -s -f http://localhost:8080/classes > /dev/null || (echo "âŒ API YanÄ±t Vermiyor!" && cat app.log && exit 1)

      # 8. POSTMAN TESTLERÄ° (NEWMAN)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Postman Collection
        run: |
          npm install -g newman
          echo "### ðŸš€ API Test Results (Newman)" >> $GITHUB_STEP_SUMMARY
          echo '```text' >> $GITHUB_STEP_SUMMARY
          newman run tests/postman/collection.json --reporter-cli-no-banner >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # 9. PERFORMANS TESTLERÄ° (k6 TAM Ã‡IKTI - DÃœZELTÄ°LDÄ°)
      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run k6 Load Test
        run: |
          echo "### âš¡ Performance Summary (k6)" >> $GITHUB_STEP_SUMMARY
          echo '```text' >> $GITHUB_STEP_SUMMARY
          # k6 Ã§Ä±ktÄ±sÄ±nÄ± doÄŸrudan summary'e yaz (tÃ¼m Ã§Ä±ktÄ±)
          k6 run tests/k6/load_test.js >> $GITHUB_STEP_SUMMARY 2>&1 || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      # 10. UYGULAMA LOGLARINI YÃœKLE
      - name: Upload Application Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: application-log
          path: app.log