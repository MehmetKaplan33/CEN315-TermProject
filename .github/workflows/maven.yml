name: Java CI with Maven (Full Suite)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      # 1. KODU Ã‡EK
      - uses: actions/checkout@v4

      # 2. JAVA 21 KUR
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      # 3. DERLEME VE TESTLER
      - name: Build and Test with Maven
        run: mvn -B verify --file pom.xml

      # --- JACOCO SUMMARY (PR Comment) ---
      - name: JaCoCo Report Summary (PR Comment)
        uses: Madrapps/jacoco-report@v1.6.1
        with:
          paths: ${{ github.workspace }}/target/site/jacoco/jacoco.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 80
          title: "ðŸ“Š JaCoCo Code Coverage Summary"
          update-comment: true

      # JaCoCo Summary'e de ekle (Sadece Instruction ve Branch Coverage)
      - name: Add JaCoCo to Step Summary
        run: |
          echo "### ðŸ“Š JaCoCo Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          JACOCO_HTML="target/site/jacoco/index.html"
          
          if [ -f "$JACOCO_HTML" ]; then
            # Instruction coverage: "26 of 296" formatÄ±ndan parse
            INST_LINE=$(grep -A1 '<tfoot>' "$JACOCO_HTML" | grep 'class="bar"' | head -1)
            INST_MISSED=$(echo "$INST_LINE" | grep -oP '\d+(?= of )' || echo "0")
            INST_TOTAL=$(echo "$INST_LINE" | grep -oP 'of \K\d+' || echo "1")
            INST_COVERED=$((INST_TOTAL - INST_MISSED))
            INST_PCT=$(awk "BEGIN {printf \"%.0f\", ($INST_COVERED/$INST_TOTAL)*100}")
          
            # Branch coverage: "1 of 14" formatÄ±ndan parse
            BRANCH_LINE=$(grep -A1 '<tfoot>' "$JACOCO_HTML" | grep 'class="bar"' | sed -n '2p')
            BRANCH_MISSED=$(echo "$BRANCH_LINE" | grep -oP '\d+(?= of )' || echo "0")
            BRANCH_TOTAL=$(echo "$BRANCH_LINE" | grep -oP 'of \K\d+' || echo "1")
            BRANCH_COVERED=$((BRANCH_TOTAL - BRANCH_MISSED))
            BRANCH_PCT=$(awk "BEGIN {printf \"%.0f\", ($BRANCH_COVERED/$BRANCH_TOTAL)*100}")
          
            # Tablo oluÅŸtur
            echo "| Metric | Coverage | Status |" >> $GITHUB_STEP_SUMMARY
            echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
            echo "| **Instruction Coverage** | ${INST_PCT}% | $([ $INST_PCT -ge 80 ] && echo "âœ…" || echo "âš ï¸") |" >> $GITHUB_STEP_SUMMARY
            echo "| **Branch Coverage** | ${BRANCH_PCT}% | $([ $BRANCH_PCT -ge 80 ] && echo "âœ…" || echo "âš ï¸") |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ JaCoCo raporu bulunamadÄ±!" >> $GITHUB_STEP_SUMMARY
          fi

      # 4. JACOCO RAPORUNU YÃœKLE
      - name: Upload JaCoCo Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-report
          path: target/site/jacoco/

      # 5. PITEST (MUTASYON) VE DÄ°NAMÄ°K VERÄ° Ã‡EKME (HTML'DEN DOÄžRU PARSE)
      - name: Run PITest and Extract Summary
        run: |
          mvn org.pitest:pitest-maven:mutationCoverage
          
          PITEST_HTML="target/pit-reports/index.html"
          
          echo "### ðŸ§¬ Mutation Testing Summary (PITest)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "$PITEST_HTML" ]; then
            # Line Coverage: 98% <div class="coverage_bar">...58/59</div>
            LINE_COV=$(grep -A2 '<th>Line Coverage</th>' "$PITEST_HTML" | grep -oP '(?<=width-)\d+' | head -1)
            LINE_RATIO=$(grep -A2 '<th>Line Coverage</th>' "$PITEST_HTML" | grep -oP '\d+/\d+' | head -1)
          
            # Mutation Coverage: 83% <div class="coverage_bar">...34/41</div>
            MUT_COV=$(grep -A2 '<th>Mutation Coverage</th>' "$PITEST_HTML" | grep -oP '(?<=width-)\d+' | head -1)
            MUT_RATIO=$(grep -A2 '<th>Mutation Coverage</th>' "$PITEST_HTML" | grep -oP '\d+/\d+' | head -1)
          
            # Test Strength: 92% <div class="coverage_bar">...34/37</div>
            TEST_STR=$(grep -A2 '<th>Test Strength</th>' "$PITEST_HTML" | grep -oP '(?<=width-)\d+' | head -1)
            TEST_RATIO=$(grep -A2 '<th>Test Strength</th>' "$PITEST_HTML" | grep -oP '\d+/\d+' | head -1)
          
            # VarsayÄ±lan deÄŸerler (parse baÅŸarÄ±sÄ±z olursa)
            LINE_COV=${LINE_COV:-0}
            MUT_COV=${MUT_COV:-0}
            TEST_STR=${TEST_STR:-0}
          
            echo "| Metric | Score | Status |" >> $GITHUB_STEP_SUMMARY
            echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
            echo "| **Line Coverage** | ${LINE_COV}% (${LINE_RATIO}) | $([ $LINE_COV -ge 80 ] && echo "âœ…" || echo "âš ï¸") |" >> $GITHUB_STEP_SUMMARY
            echo "| **Mutation Coverage** | ${MUT_COV}% (${MUT_RATIO}) | $([ $MUT_COV -ge 80 ] && echo "âœ…" || echo "âš ï¸") |" >> $GITHUB_STEP_SUMMARY
            echo "| **Test Strength** | ${TEST_STR}% (${TEST_RATIO}) | $([ $TEST_STR -ge 80 ] && echo "âœ…" || echo "âš ï¸") |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ PITest raporu bulunamadÄ±!" >> $GITHUB_STEP_SUMMARY
          fi

      # 6. PITEST RAPORUNU YÃœKLE
      - name: Upload PITest Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pitest-report
          path: target/pit-reports/

      # 7. UYGULAMAYI ARKA PLANDA BAÅžLAT
      - name: Start Spring Boot App
        run: |
          nohup java -jar target/*.jar > app.log 2>&1 &
          echo "Uygulama baÅŸlatÄ±lÄ±yor, 25 saniye bekleniyor..."
          sleep 25
          curl -s -f http://localhost:8080/classes > /dev/null || (echo "âŒ API YanÄ±t Vermiyor!" && cat app.log && exit 1)

      # 8. POSTMAN TESTLERÄ° (NEWMAN)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Postman Collection
        run: |
          npm install -g newman
          echo "### ðŸš€ API Test Results (Newman)" >> $GITHUB_STEP_SUMMARY
          echo '```text' >> $GITHUB_STEP_SUMMARY
          newman run tests/postman/collection.json --reporter-cli-no-banner >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # 9. PERFORMANS TESTLERÄ° (k6 TAM Ã‡IKTI)
      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Run k6 Load Test
        run: |
          echo "### âš¡ Performance Summary (k6)" >> $GITHUB_STEP_SUMMARY
          echo '```text' >> $GITHUB_STEP_SUMMARY
          k6 run tests/k6/load_test.js >> $GITHUB_STEP_SUMMARY 2>&1 || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      # 10. UYGULAMA LOGLARINI YÃœKLE
      - name: Upload Application Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: application-log
          path: app.log